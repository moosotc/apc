version = 1.00b

.PHONY: all clean dist mod opt
.DEFAULT: all

clibs =
    if $(equal $(shell uname), SunOS)
        value -cclib -lkstat
Mocamlcc (ml_apc, -Wall -Werror -g -I/usr/X11R6/include)
Mocamlc (apc, -warn-error A -g -thread -I +lablGL)
Mocamlopt (apc, -warn-error A -thread -I +lablGL)

objs = ml_apc.o
libs = unix lablgl lablglut threads

section
    cmos = apc.cmo
    libs = $(addsuffix .cma, $(libs))
    flags = -thread -custom -I +lablGL
    apc.byte: $(cmos) $(objs)
        ocamlc.opt $(flags) -o $@ $(libs) $(caml-sort $(cmos)) $(objs) $(clibs)

section
    cmxs = apc.cmx
    libs = $(addsuffix .cmxa, $(libs))
    flags = -thread -I +lablGL
    apc.opt: $(cmxs) $(objs) apc.o
        ocamlopt.opt $(flags) -o $@ $(libs) $(caml-sort $(cmxs)) $(objs) $(clibs)

mkdir -p mod
add-project-directories ($(dirof OMakefile)/mod)
vmount (-l, $(dirof OMakefile)/mod, mod)
.SUBDIRS: mod
    mod: itc-mod.c Makefile
        make

all: apc.byte
opt: apc.opt

apc-$(version).tgz: $(shell cat FILES)
    rm -fr apc-$(version)
    mkdir -p apc-$(version)
    tar -T $(file FILES) -chf - -C $(dirof FILES) | tar xf - -C apc-$(version)
    tar cfz $@ apc-$(version)

dist: apc-$(version).tgz
